# LSTM 모델과 감정 분석 모델 통합 방안

## 1. 각 모델의 출력(Output) 구조

### LSTM 모델 출력

`model_with_entmax.py`의 `AttentionLSTMModel` 모델은 다음과 같은 출력을 생성한다:

```python
# 출력 형태
output = {
    'predictions': torch.Tensor,  # 형태: [batch_size, target_size]
                                  # 예: [1, 14] - 14일간의 예측 가격
    'attention_weights': torch.Tensor,  # 형태: [batch_size, seq_length]
                                       # 각 시점별 어텐션 가중치
}

# 실제 사용 예시: 14일 후의 커피 가격 예측값
predictions = output['predictions'].cpu().numpy()  # 예: [210.5, 212.3, 215.7, ...]
```

이 모델은 커피 가격의 미래 14일 예측값을 출력하며, 모델이 예측 시 어떤 과거 시점에 주의를 기울였는지 보여주는 어텐션 가중치도 함께 제공한다.

### 감정 분석 모델 출력

감정 분석 파이프라인의 최종 출력은 다음과 같은 시계열 데이터프레임이다:

```python
# 일별 감정 데이터
daily_sentiment_df = {
    'date': ['2023-01-01', '2023-01-02', ...],  # 날짜
    'sentiment_avg': [0.35, -0.12, ...],  # 일별 평균 감정 점수 (-1~1)
    'positive_ratio': [0.6, 0.3, ...],  # 긍정 기사 비율
    'negative_ratio': [0.2, 0.5, ...],  # 부정 기사 비율
    'article_volume': [15, 23, ...],  # 일별 기사 수
    'sentiment_momentum_7': [0.1, -0.2, ...],  # 7일 감정 모멘텀
    'sentiment_volatility_7': [0.05, 0.12, ...],  # 7일 감정 변동성
    'sentiment_shock': [0, 1, ...],  # 감정 급변 여부
    'volume_surge': [0, 1, ...],  # 뉴스 급증 여부

    # 측면별 감정 점수
    'PRICE_sentiment': [0.25, -0.3, ...],  # 가격 관련 감정
    'SUPPLY_sentiment': [0.15, -0.4, ...],  # 공급 관련 감정
    'DEMAND_sentiment': [0.32, 0.1, ...],  # 수요 관련 감정
    'WEATHER_sentiment': [-0.5, 0.2, ...],  # 날씨 관련 감정
    'POLICY_sentiment': [0.12, 0.05, ...],  # 정책 관련 감정

    # 지연 효과 피처들
    'sentiment_avg_lag_1': [None, 0.35, ...],  # 1일 전 감정
    'sentiment_avg_lag_3': [None, None, None, ...],  # 3일 전 감정
    'sentiment_avg_lag_7': [None, None, ..., 0.2],  # 7일 전 감정
}
```

이 데이터는 날짜별로 뉴스 감정 분석 결과를 요약하며, 감정 점수, 감정 변화 패턴, 측면별 감정 분석 등 다양한 정보를 포함한다.

## 2. 모델 통합 방향

LSTM 모델과 감정 분석 모델을 통합하는 세 가지 주요 방향이 있다:

### 방향 1: 특성 수준 통합 (Feature-level Integration)

**개념**: 감정 분석 결과를 LSTM 모델의 입력 특성으로 추가하는 방식

**접근 방법**:

-   기존 LSTM 모델의 입력 차원을 확장해 감정 분석 결과를 추가 피처로 사용
-   거시경제 데이터, 기후 데이터, 감정 데이터를 단일 피처 벡터로 합침
-   기존 LSTM 모델의 아키텍처는 그대로 유지한 채 입력만 확장
-   Entmax Attention 메커니즘은 입력 데이터의 유형을 구분하지 않고 전체 데이터에 적용

**장점**:

-   구현이 간단하고 직관적
-   기존 LSTM 모델의 코드를 대부분 재사용 가능
-   추가 학습 파라미터가 적어 과적합 위험이 낮음

**단점**:

-   감정 데이터와 시계열 데이터의 서로 다른 특성을 고려하지 못함
-   특성 수가 증가하면서 주요 특성의 중요도가 희석될 수 있음
-   서로 다른 시간 스케일을 가진 데이터의 통합이 어려움

### 방향 2: 모델 앙상블 (Model Ensemble)

**개념**: 두 모델을 독립적으로 학습한 후 결과를 가중 결합하는 방식

**접근 방법**:

-   기존 Attention LSTM 모델은 거시경제/기후 데이터만으로 학습
-   새로운 모델은 감정 데이터만을 사용해 별도로 학습 (LSTM 또는 다른 아키텍처)
-   두 모델의 예측 결과에 가중치를 적용해 최종 예측 생성
-   가중치는 검증 데이터셋을 통해 최적화

**장점**:

-   각 데이터 유형에 맞는 독립적인 모델 설계 가능
-   기존 LSTM 모델을 그대로 활용할 수 있음
-   각 모델을 독립적으로 개선하거나 교체 가능
-   하이퍼파라미터 튜닝이 더 단순해짐

**단점**:

-   두 데이터 유형 간의 복잡한 상호작용을 포착하기 어려움
-   최적의 가중치 찾기가 복잡할 수 있음
-   두 모델 모두 학습해야 하므로 전체 계산 비용 증가

### 방향 3: 이중 입력 모델 (Dual-Input Model)

**개념**: 두 유형의 데이터를 별도의 네트워크로 처리한 후 통합하는 새로운 모델 설계

**접근 방법**:

-   시계열 데이터용 LSTM 인코더와 감정 데이터용 LSTM 인코더를 별도로 설계
-   각 인코더에 특화된 어텐션 메커니즘 적용
    -   시계열 데이터: Entmax Attention (급격한 변화에 민감하게 반응)
    -   감정 데이터: 감정 특화 어텐션 (중요한 감정 특성에 집중)
-   두 인코더의 출력을 결합하여 통합 표현 생성
-   통합 표현을 통한 최종 예측 레이어 설계

**장점**:

-   각 데이터 유형의 고유한 패턴과 특성을 효과적으로 포착
-   데이터 유형 간의 복잡한 상호작용 학습 가능
-   급등락 예측 능력 향상 가능성이 큼
-   각 데이터 스트림에 맞춤형 처리 가능

**단점**:

-   모델 아키텍처가 복잡해짐
-   기존 모델 코드를 대폭 수정해야 함
-   학습 파라미터가 증가하여 과적합 위험이 커짐
-   더 많은 학습 데이터와 계산 리소스 필요

## 3. 통합 시 주요 고려사항

모델 통합 시 특히 주의해야 할 점들:

### 1. 데이터 시간 정렬

-   거시경제/기후 데이터와 감정 데이터의 타임스탬프 일치 필요
-   다른 주기로 수집된 데이터의 적절한 집계 또는 보간 필요
-   시간대(timezone) 불일치 문제 해결

### 2. 결측치 처리

-   감정 데이터가 없는 날짜에 대한 처리 전략 (전방 채우기, 보간법 등)
-   기사량이 적은 날의 감정 점수 신뢰성 문제 해결
-   이상치(outlier) 감지 및 처리

### 3. 특성 선택 및 차원 감소

-   모든 감정 특성 대신 예측력 높은 특성만 선택
-   주성분 분석(PCA) 등을 통한 차원 감소 고려
-   특성 중요도 분석을 통한 불필요한 특성 제거

### 4. 시간 지연 효과 모델링

-   뉴스가 가격에 미치는 영향의 시간적 지연 고려
-   다양한 지연 기간(lag)에 대한 실험 필요
-   감정 데이터의 누적 효과 모델링

## 4. 권장 통합 전략

프로젝트 상황을 고려할 때, 다음과 같은 단계별 접근법을 권장한다:

### 1단계: 특성 수준 통합 (빠른 구현)

-   감정 데이터 중 가장 중요한 몇 가지 특성만 선택하여 LSTM 모델 입력에 추가
-   기존 `model_with_entmax.py` 코드를 최소한으로 수정하여 빠르게 결과 확인
-   이 접근법으로 감정 데이터의 기본적인 영향력 평가

### 2단계: 앙상블 접근법 (중간 단계)

-   감정 데이터만을 사용하는 별도의 예측 모델 개발
-   기존 LSTM 모델과 새 모델의 예측을 가중 결합
-   다양한 가중치 조합으로 성능 테스트

### 3단계: 이중 입력 모델 (최종 목표)

-   두 데이터 스트림을 별도로 처리하는 고급 모델 설계
-   각 스트림에 맞춤형 어텐션 메커니즘 적용
-   풍부한 중간 표현을 결합하여 최종 예측 생성

이러한 단계적 접근은 빠른 결과를 얻으면서도 점진적으로 모델을 개선할 수 있는 장점이 있다. 각 단계에서 얻은 인사이트를 다음 단계 설계에 반영하면 최종적으로 더 강력한 통합 모델을 만들 수 있을 것이다.

## 5. 결론

LSTM 모델과 감정 분석 모델의 통합은 커피 가격 예측 성능, 특히 급등락 예측 능력을 크게 향상시킬 잠재력이 있다. 특히 이중 입력 모델 접근법이 장기적으로 가장 효과적일 것으로 예상되지만, 구현 복잡성을 고려할 때 단계적인 접근이 실용적이다.

각 단계에서 모델 평가를 통해 감정 데이터가 예측 정확도에 미치는 영향을 분석하고, 특히 급격한 가격 변동 시점에서의 예측 성능 변화에 주목해야 한다. 이러한 과정을 통해 최적의 통합 전략을 찾아내고, 커피 가격의 복잡한 움직임을 더 정확히 예측할 수 있는 모델을 개발할 수 있을 것이다.

### 1. 어텐션 LSTM 모델 (Time Series)

경제지표와 기후 데이터를 함께 활용하는 어텐션 메커니즘 기반 LSTM 모델이다. 기존 LSTM 모델에 entmax 어텐션을 추가하여 급등락 포착 능력을 향상시켰다.

-   **입력 데이터**: 거시경제지표, 기후데이터
-   **출력**: 14일간의 커피 선물 가격 예측
-   **특징**: Entmax 어텐션을 통해 급격한 가격 변동에 더 민감하게 반응
-   **모듈 구조**:
    -   `data_preprocessing.py`: 데이터 전처리
    -   `dataset.py`: PyTorch 데이터셋 클래스
    -   `model.py`: 어텐션 LSTM 모델 정의
    -   `training.py`: 모델 학습 로직
    -   `utils.py`: 유틸리티 함수
    -   `main.py`: 메인 실행 코드

### 2. 감정 분석 모델 (Sentiment)

뉴스 기사의 감정을 추출하여 커피 가격에 영향을 미치는 시장 심리를 분석한다.

-   **입력 데이터**: 커피 관련 뉴스 기사
-   **출력**: 일별 감정 점수, 감정 변화 추이, 측면별 감정 분석 등
-   **개발 예정**: 현재 개발 중인 모듈로 향후 업데이트 예정

### 3. 모델 통합 방향

어텐션 LSTM 모델과 감정 분석 모델의 통합을 통해 예측 정확도를 높일 계획이다. 통합 방식은 아래와 같이 세 가지 방향을 고려 중이다:

1. **특성 수준 통합**: 감정 분석 결과를 LSTM 모델의 추가 입력 특성으로 사용
2. **모델 앙상블**: 두 독립 모델의 예측을 가중 결합
3. **이중 입력 모델**: 두 데이터 스트림을 별도로 처리 후 통합

> 자세한 모델 통합 방안은 [모델 통합 방안](docs/모델%20통합%20방안.md) 문서를 참고.
