# LSTM-Entmax 커피 가격 예측 모델

## 모델 설명

이 모델은 **LSTM(Long Short-Term Memory)** 기반의 시계열 예측 모델에 **Entmax 어텐션** 메커니즘을 결합하여 커피 가격을 예측한다.

-   **LSTM**: 시계열 데이터의 장기 의존성을 효과적으로 학습하는 순환 신경망(RNN) 구조.
-   **Entmax 어텐션**: 소프트맥스(softmax) 대신 **Entmax**(특히 Entmax15)를 사용한 어텐션 메커니즘으로, 희소(sparse)한 어텐션 분포를 만들어 해석력과 성능을 높임.
-   **정적 피처 결합**: 시계열 입력 외에도 경제/기후 등 정적 피처를 함께 입력받아 예측 성능을 향상.
-   **커스텀 손실 함수**: 방향성 손실, 분산 손실 등 시계열 예측에 특화된 손실 함수를 추가로 사용.

모델 예측 과정은 다음과 같다:

1. **데이터 분할**: 전체 데이터셋을 80%는 학습용, 20%는 테스트용으로 나눈다.
2. **테스트 기간 예측(`predict_and_inverse`)**: 이 함수는 테스트 데이터에서 일정 구간(예: 100일)을 기준으로 모델이 향후 14일간의 커피 가격 수익률을 예측하고, 이를 실제 가격으로 복원한다.
    - 예를 들어 2023년 5월 10일이 마지막 입력일이라면, 해당 시점의 실제 가격(예: 190.0)을 기준으로 수익률 예측값을 곱해 2023년 5월 11일부터 24일까지의 가격을 계산한다. 이렇게 얻은 예측 결과들을 반복 수집하여 평균을 내면, 전체 테스트 구간에 대한 안정된 커피 가격 예측 시계열이 생성된다.
3. **테스트 데이터 셋 이후 14일 예측(`predict_future`)**: 이 함수는 테스트 데이터의 마지막 data_window 일간 시계열 데이터를 기반으로, 향후 future_target 일간의 커피 수익률을 한 번에 예측한다. 예측된 수익률은 역정규화를 거쳐 실제 커피 가격으로 변환되며, 가장 마지막 실제 가격을 기준으로 누적 계산된다.

    - data_window = 100, future_target = 14, test_df의 마지막 날짜가 2023-04-09라고 가정

    - 2023-01-01 ~ 2023-04-09 중 마지막 100일 데이터를 입력으로 사용

    - 모델은 한 번의 예측으로 2023-04-10 ~ 2023-04-23의 수익률을 출력하고, 마지막 실제 가격(예: 192.0)을 기준으로 예측 수익률을 누적 곱하여 14일 예측 가격을 계산

> **모델 확장**: 실시간 데이터 수집이 가능하다면, 오늘 기준 1년 전부터를 test set으로 설정하여 `predict_and_inverse`를 통해 예측 성능을 검증할 수 있다. 이후, 오늘 기준 14일 뒤의 커피 가격 흐름은 `predict_future`를 통해 예측 가능하며, 실제 시계열 예측 및 투자 판단에 활용할 수 있다.

## 주요 파일 설명

-   **models.py**  
    LSTM + Entmax 어텐션 + 정적 피처 결합 모델 정의

    -   `EntmaxAttention`: Entmax 기반 어텐션 레이어
    -   `AttentionLSTMModel`: 전체 모델 구조 (LSTM, 어텐션, 게이트, 정적 피처 결합)

-   **losses.py**  
    커스텀 손실 함수

    -   `directional_loss`: 예측값과 실제값의 변화 방향 일치 여부
    -   `variance_loss`: 예측값과 실제값의 분산 차이

-   **trainer.py**  
    모델 학습, 예측, 평가 함수

    -   `train_model`: 복합 손실로 학습
    -   `predict_and_inverse`, `predict_future`: 예측 및 역정규화
    -   `evaluate_and_save`: 결과 평가 및 저장

-   **data_loader.py**  
    경제/기후 데이터 로딩 및 예측 결과 저장 함수

-   **preprocessor.py**  
    데이터 전처리 및 피처 생성, 정규화, 분할 함수

-   **dataset.py**  
    PyTorch용 시계열+정적 피처 데이터셋 클래스

-   **coffee_price_fetcher.py**  
    yfinance를 이용한 커피 선물 가격 수집, 예측 결과에 실제 가격 추가

-   **visualizer.py**  
    학습 곡선, 예측 결과 등 시각화 함수

-   **utils.py**  
    장치 선택, 어텐션 엔트로피 계산 등 보조 함수

-   **run_model.py**  
    전체 파이프라인 실행 메인 파일 (명령행 인자 기반 실행)

-   \***\*init**.py\*\*  
    패키지 초기화 및 주요 함수/클래스 export

---

## 참고

-   Entmax 어텐션 논문:  
    _Peters, M. E., et al. "Sparse Sequence-to-Sequence Models." arXiv preprint arXiv:1905.05702 (2019)._
-   yfinance, pandas, torch 등 주요 라이브러리 사용

---
