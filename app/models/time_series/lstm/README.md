# ☕ LSTM + Attention 기반 커피 가격 예측 모델

이 프로젝트는 기후 데이터를 활용해 **커피 생두 가격(Coffee Price)**을 예측하는 시계열 분석 시스템이다.  
LSTM 기반 모델에 Attention 메커니즘을 결합했고, Softmax나 Entmax를 선택적으로 사용할 수 있게 설계했다.

## 📁 프로젝트 구조

```bash
LSTM
├── data_preprocessor.py    # 데이터 로딩 및 전처리
├── model.py                # 모델 정의 및 학습, 예측 함수
├── run_model.py            # 전체 파이프라인 실행 모듈
├── debug.py                # 데이터 형태 디버깅
├── utils.py                # 결과 저장 및 시각화
└── README.md               # 프로젝트 설명서
```

## 사용 데이터

-   **입력 컬럼**:
    -   `Date`
    -   `Coffee_Price`
    -   `Coffee_Price_Return`
    -   `location_PRECTOTCORR` (보정된 총 강수량)
    -   `location_season_tag` (수확기 분류 태그)
    -   `location_days_until_harvest` (수확까지 남은 일 수)

> PRECTOTCORR는 보통 **Precipitation Total Corrected (보정된 총 강수량)**을 의미한다.
> 단위: 밀리미터(mm) 또는 킬로그램/제곱미터(kg/m²)

-   **전처리**:
    -   lag 피처 제거
    -   범주형 인코딩 (`season_tag`)
    -   수치형 정규화
    -   파생 피처 생성:
        -   변동성 (5, 10, 20일)
        -   모멘텀
        -   볼린저 밴드 너비
        -   Z-Score
        -   절대 수익률

## 모델만 실행 방법

```bash
cd app
python -m models.time_series.lstm.run_model --loss_fn mse --epochs 10
```

> 서버 실행 시 자동으로 모델 학습이 진행된다.

```bash
cd app

# PowerShell에서 환경 변수 설정
$env:COFFEE_MODEL_LOSS_FN = "huber"
$env:COFFEE_MODEL_DELTA = "1.0"
$env:COFFEE_MODEL_EPOCHS = "5"
$env:COFFEE_MODEL_LR = "0.001"
$env:COFFEE_MODEL_ONLINE = "False"
$env:COFFEE_MODEL_TARGET = "price"   # price or return

# 환경 변수 확인
$env:COFFEE_MODEL_LOSS_FN
$env:COFFEE_MODEL_DELTA
$env:COFFEE_MODEL_EPOCHS
$env:COFFEE_MODEL_LR
$env:COFFEE_MODEL_ONLINE
$env:COFFEE_MODEL_TARGET

# 서버 실행
uvicorn main:app --reload
```

## 파라미터

| 옵션        | 설명                                | 기본값  |
| ----------- | ----------------------------------- | ------- |
| `--loss_fn` | 손실 함수 선택 (`mse` 또는 `huber`) | `mse`   |
| `--delta`   | Huber Loss 사용 시 임계값           | `1.0`   |
| `--epochs`  | 학습 에폭 수                        | `5`     |
| `--lr`      | 학습률                              | `0.001` |

## 출력 및 시각화

> `data/output/result`에 저장된다.

-   모델 저장(`coffee_price_model.pth`)
-   사용된 하이퍼 파라미터(`hyperparameters.txt`)
-   예측 결과 그래프 (`prediction_sample.png`)
-   학습 손실 시각화 (`training_loss.png`)
-   전체 성능 요약 (`model_performance_summary.png`)
-   슬라이딩 윈도우 예측 결과 (`sliding_window_predictions.csv`)
-   슬라이딩 윈도우 예측 결과 이미지 (`sliding_window_predictions.png`)
-   성능 지표 (`metrics.txt`)
    -   MAE
    -   RMSE

## 슬라이딩 윈도우 예측 (선택적)

`run_model.py`에서 슬라이딩 윈도우 방식으로 예측하고, 연속적인 결과를 저장하고 시각화할 수 있다.

```
run_sliding = True  # 코드 내에서 활성화
```

## 모델 리뷰

### 모델 성능 분석

현재 Huber Loss (delta=0.5)와 5 에폭으로 학습된 모델의 성능을 분석.

#### 성능 지표

-   **MAE (평균 절대 오차)**: 22.58
-   **RMSE (평균 제곱근 오차)**: 35.64

이런 지표는 커피 생두 가격의 스케일 내에서 평가해야 한다. 그래프를 보면 실제 가격이 약 150~450 범위에 있으므로, MAE 22.58은 전체 범위의 약 7.5%에 해당하는 오차다.

#### 학습 과정 분석

학습 손실 그래프를 보면:

-   학습 손실(파란색)과 검증 손실(주황색) 모두 에폭이 증가함에 따라 꾸준히 감소한다
-   약 10 에폭 이후부터는 손실 감소 속도가 느려진다
-   40 에폭까지 지속적으로 손실이 감소하여 과적합 문제가 관찰되지 않는다
-   학습 손실과 검증 손실 간의 간격이 유지되는데, 이는 모델이 학습 데이터에 더 잘 맞는 일반적인 현상이다

#### 예측 결과 분석

전체 시계열 예측 결과에서 다음을 관찰할 수 있다:

-   모델이 전반적인 추세를 잘 따라간다
-   2023년 6월~10월: 모델이 가격 하락 추세를 정확히 예측한다
-   2023년 11월~2024년 4월: 가격 상승 패턴을 적절히 포착한다
-   2024년 5월~10월: 변동성 있는 구간에서도 전반적인 추세를 추적한다
-   **2025년 1월~3월**: 급격한 가격 상승을 과소 예측하는 경향이 뚜렷하다

모델의 주요 약점은 급격한 변동(특히 급등)에 대한 반응이 둔한 점이다. 이는 시계열 예측 모델의 일반적인 특성으로, 극단적 이벤트를 예측하기 어렵기 때문이다.

#### 슬라이딩 윈도우 분석

슬라이딩 윈도우 예측 결과는 단기 예측의 품질을 보여준다:

-   각 윈도우에서 14일 예측을 수행한다
-   예측과 실제 값이 전반적으로 비슷한 패턴을 보인다
-   일부 구간(특히 10일차 부근)에서 모델이 실제 값보다 높게 예측하는 경향이 있다
-   예측이 실제 값보다 변동성이 적고 완만한 경향이 있다

### 개선 방향

현재 모델의 성능을 바탕으로 다음과 같은 개선 방향을 제안한다:

1. **더 긴 학습 에폭**: 손실 그래프가 40 에폭까지도 계속 감소하는 것으로 보아, 현재 5 에폭은 충분하지 않을 수 있다. 10~20 에폭으로 증가시키는 것을 고려해볼 수 있다.

> 50까지 해본 결과 5 이후부터 진동이 매우 심하다.

2. **극단적 변동에 대한 가중치 부여**: 급격한 가격 상승/하락 구간에 더 높은 가중치를 부여하는 사용자 정의 손실 함수를 고려할 수 있다.

3. **앙상블 접근법**: 서로 다른 하이퍼파라미터(예: MSE와 Huber 손실)로 학습된 여러 모델의 예측을 결합하면 극단적 변동에 대한 대응력이 향상될 수 있다.

4. **추가 특성 도입**: 커피 가격에 영향을 미치는 다른 요소(예: 글로벌 커피 공급 지표, 주요 생산국의 경제 지표)를 모델에 포함시키는 것을 고려해볼 수 있다.

5. **변동성 예측 모델 추가**: 가격 자체뿐만 아니라 변동성을 예측하는 보조 모델을 도입하여 신뢰 구간을 제공하는 방안을 고려할 수 있다.

### 결론

현재 모델은 커피 생두 가격의 전반적인 추세를 잘 포착하고 있으나, 급격한 가격 변동에 대한 예측력이 제한적이다. Huber Loss의 사용은 이상치에 강건한 학습을 가능하게 하지만, 여전히 극단적 가격 변동을 과소 예측하는 경향이 있다.

추가 학습 에폭과 앙상블 접근법 도입을 통해 모델의 예측 정확도를 더욱 향상시킬 수 있을 것으로 기대된다. 또한 모델의 출력을 단일 예측값이 아닌 확률적 예측 범위로 확장하는 것도 사용자에게 더 유용한 정보를 제공할 수 있을 것이다.

## 라이선스

MIT License
Copyright (c) 2025
